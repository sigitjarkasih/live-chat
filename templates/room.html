{% extends 'base.html' %}

{% block content %}

<!-- Tailwind CSS CDN -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

<style>
  body {
      font-family: 'Arial', sans-serif;
  }
  .chat-bubble {
    padding: 10px;
    border-radius: 10px;
    margin: 5px 0;
    max-width: 80vw; /* agar sesuai lebar layar mobile */
  }
</style>

<div class="flex flex-col md:flex-row min-h-screen bg-gray-100">

  <!-- Sidebar -->
  <aside class="bg-blue-700 text-white p-5 w-full md:w-1/4 flex-shrink-0 flex flex-col">
    <h2 class="text-xl font-semibold mb-6">ChatApp</h2>
    <div id="user-list" class="space-y-1 overflow-auto max-h-60 md:max-h-full">
      <p class="font-semibold truncate">{{ name }}</p>
    </div>
  </aside>

   <!-- Chat Section -->
   <main class="flex flex-col flex-grow w-full md:w-3/4 p-4 md:p-5">
    <div class="bg-white rounded-lg shadow-lg flex flex-col flex-grow max-h-[calc(100vh-4rem)]">

      <!-- Header -->
      <header class="flex justify-between items-center border-b p-3">
        <h3 class="text-lg font-semibold truncate">Chat Room: {{ code }}</h3>
      </header>

      <!-- Chat Messages -->
      <section
        id="messages"
        class="flex flex-col flex-grow overflow-y-auto px-4 py-3 space-y-2"
        role="log"
        aria-live="polite"
        aria-relevant="additions"
      >
        {% for msg in messages %}
        <div
          class="chat-bubble max-w-full sm:max-w-[75%] p-3 rounded-lg
                 {% if msg.name == username %}
                   bg-green-200 self-end text-right
                 {% else %}
                   bg-gray-300 self-start text-left
                 {% endif %}"
          style="word-break: break-word;"
        >
          <p><strong>{{ msg.name }}</strong>: {{ msg.message }}</p>
          <span class="text-xs text-gray-500">{{ msg.timestamp }}</span>
        </div>
        {% endfor %}
      </section>

      <!-- Message Input -->
      <footer class="border-t p-3">
        <form id="chatForm" class="flex items-center space-x-3" onsubmit="return false;" aria-label="Chat message form">
          <input
            type="text"
            id="message"
            placeholder="Ketik Pesan..."
            class="flex-grow border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            autocomplete="off"
            aria-label="Type your message"
          />
          <button
            type="submit"
            id="sendBtn"
            class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-full transition disabled:opacity-50 disabled:cursor-not-allowed"
            aria-label="Send message"
            disabled
          >
            Kirim
          </button>
        </form>
      </footer>
    </div>

    <!-- Footer -->
    <footer class="mt-4 text-center text-sm text-gray-600 select-none">
      Â© <span id="year"></span> PT Wahana Prestasi Logistik. All Rights Reserved.
    </footer>
  </main>
</div>

<!-- Notification Sound -->
<audio id="notifSound" src="https://www.soundjay.com/buttons/sounds/button-16.mp3" preload="auto"></audio>

<script>
  const socketio = io();
  const messages = document.getElementById("messages");
  const messageInput = document.getElementById("message");
  const notifSound = document.getElementById("notifSound");
  const chatForm = document.getElementById("chatForm");
  const sendBtn = document.getElementById("sendBtn");
  const currentUsername = "{{ username | default('Guest') }}";
  // Scroll to latest message
  function scrollToBottom() {
    messages.scrollTop = messages.scrollHeight;
  }

  // Generate message bubble
  function createMessage(name, msg) {
    const time = new Date().toLocaleString("id-ID", { timeZone: "Asia/Jakarta" });
    const isSent = name === currentUsername;

    const bubble = document.createElement("div");
    bubble.className = `chat-bubble max-w-[75%] p-3 rounded-lg ${
      isSent ? "bg-green-200 self-end text-right" : "bg-gray-300 self-start text-left"
    }`;

    bubble.innerHTML = `<p><strong>${name}</strong>: ${msg}</p><span class="text-xs text-gray-500">${time}</span>`;
    messages.appendChild(bubble);
    scrollToBottom();

    if (!isSent) notifSound.play();
  }

  // Receive message
  socketio.on("message", (data) => {
    createMessage(data.name, data.message);
  });

  // Update user list
  socketio.on("update_users", function(users) {
    const userList = document.getElementById("user-list");
    userList.innerHTML = "";

    users.forEach(function(user) {
      const div = document.createElement("div");
      div.className = "flex items-center space-x-2 truncate";
      div.innerHTML = `
        <div class="h-3 w-3 bg-green-400 rounded-full animate-pulse flex-shrink-0"></div>
        <p class="font-semibold truncate">${user}</p>
      `;
      userList.appendChild(div);
    });
  });

  // Send message
  function sendMessage() {
    const msg = messageInput.value.trim();
    if (!msg) return;
    socketio.emit("message", { data: msg });
    messageInput.value = "";
    sendBtn.disabled = true;
  }

  // Enable/Disable button
  messageInput.addEventListener("input", () => {
    sendBtn.disabled = messageInput.value.trim() === "";
  });

  // Send on form submit
  chatForm.addEventListener("submit", (e) => {
    e.preventDefault();
    sendMessage();
  });

  // Send on Enter
  messageInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Set footer year
  document.getElementById("year").textContent = new Date().getFullYear();

  // Auto scroll on load
  window.onload = scrollToBottom;
</script>
{% endblock %}
